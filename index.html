<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Космическая Кузница</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/vk-bridge.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Основные стили и запрет взаимодействия с системой --- */
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Запрет прокрутки */
            touch-action: none; /* Запрет жестов, вызывающих прокрутку */
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background: #00000a;
            color: #e0e0ff;
            user-select: none; /* Запрет выделения текста */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(100, 100, 255, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(255, 100, 150, 0.2) 0%, transparent 40%);
        }

        /* --- Анимации --- */
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 40px #4a00e0, 0 0 60px #8e2de2, inset 0 0 20px rgba(255, 255, 255, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 60px #8e2de2, 0 0 90px #4a00e0, inset 0 0 30px rgba(255, 255, 255, 0.5); }
        }

        @keyframes star-dust-animation {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-150px) scale(0.5); opacity: 0; }
        }

        @keyframes number-pop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .star-dust {
            position: absolute;
            font-size: 2rem;
            color: #fff;
            text-shadow: 0 0 5px #fff, 0 0 10px #ff0;
            animation: star-dust-animation 1s ease-out forwards;
            pointer-events: none;
        }

        .number-pop-animation {
            animation: number-pop 0.3s ease-in-out;
        }

        #proto-star {
            animation: pulse 5s infinite ease-in-out;
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <!-- Основной контейнер игры -->
    <div id="game-container" class="w-full h-full max-w-7xl max-h-[1200px] mx-auto flex flex-col p-4 sm:p-8 gap-8 items-center justify-center">

        <!-- Статистика -->
        <div class="w-full max-w-md text-center bg-black/30 p-4 sm:p-6 rounded-xl border border-purple-700/50 shadow-lg">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-yellow-300 drop-shadow-[0_0_5px_rgba(255,255,0,0.7)]" id="stardust-counter">0</h1>
            <p class="text-base sm:text-lg text-purple-300 mt-2">Звёздной Пыли</p>
        </div>

        <!-- Зона клика (Протозвезда) -->
        <div id="click-area" class="relative w-full flex-grow flex items-center justify-center">
            <div id="proto-star" class="w-[200px] h-[200px] sm:w-[250px] sm:h-[250px] md:w-[300px] md:h-[300px] lg:w-[400px] lg:h-[400px] bg-gradient-to-br from-yellow-200 via-orange-400 to-red-500 rounded-full cursor-pointer transition-transform duration-100 active:scale-95 flex items-center justify-center">
                 <div class="w-full h-full bg-white/30 rounded-full blur-xl"></div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Проверка на наличие vkBridge и его инициализация ---
            const isVkEnv = typeof vkBridge !== 'undefined';
            if (isVkEnv) {
                vkBridge.send('VKWebAppInit');
            }

            // --- Элементы DOM ---
            const stardustCounter = document.getElementById('stardust-counter');
            const protoStar = document.getElementById('proto-star');
            const clickArea = document.getElementById('click-area');

            // --- Игровое состояние ---
            let gameState = {
                stardust: 0,
            };

            const STARDUST_PER_CLICK = 1;
            const SAVE_KEY = 'cosmicForgeSaveData'; // Ключ для хранения

            // --- Форматирование чисел ---
            const formatNumber = (num) => {
                if (num < 1000) return num.toFixed(0);
                const suffixes = ["", "K", "M", "B", "T", "Qa", "Qi"];
                const i = Math.floor(Math.log10(num) / 3);
                const value = (num / Math.pow(1000, i));
                return value.toFixed(i > 0 ? 2 : 0) + suffixes[i];
            };

            // --- Обновление UI ---
            const updateUI = () => {
                stardustCounter.textContent = formatNumber(gameState.stardust);
                stardustCounter.classList.add('number-pop-animation');
                stardustCounter.onanimationend = () => stardustCounter.classList.remove('number-pop-animation');
            };

            // --- Клик по звезде ---
            protoStar.addEventListener('mousedown', (e) => {
                gameState.stardust += STARDUST_PER_CLICK;
                updateUI();

                // Создание визуального эффекта "+1"
                const dust = document.createElement('div');
                dust.className = 'star-dust';
                dust.textContent = `+${STARDUST_PER_CLICK}`;
                
                const rect = clickArea.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                dust.style.left = `${x}px`;
                dust.style.top = `${y}px`;
                clickArea.appendChild(dust);

                setTimeout(() => {
                    dust.remove();
                }, 1000);
            });
            
            // --- Сохранение и загрузка ---
            const saveGame = () => {
                const data = JSON.stringify(gameState);
                if (isVkEnv) {
                    vkBridge.send('VKWebAppStorageSet', { 
                        key: SAVE_KEY, 
                        value: data 
                    }).catch(error => {
                        console.error("Ошибка сохранения в VK Storage:", error);
                    });
                } else {
                    localStorage.setItem(SAVE_KEY, data);
                }
            };

            const loadGame = async () => {
                try {
                    let savedState = null;
                    if (isVkEnv) {
                        const receivedData = await vkBridge.send('VKWebAppStorageGet', { keys: [SAVE_KEY] });
                        if (receivedData.keys[0].value) {
                            savedState = JSON.parse(receivedData.keys[0].value);
                        }
                    } else {
                        const localData = localStorage.getItem(SAVE_KEY);
                        if (localData) {
                            savedState = JSON.parse(localData);
                        }
                    }

                    if (savedState && typeof savedState.stardust === 'number') {
                       gameState = savedState;
                    }
                } catch (error) {
                    console.error("Ошибка загрузки:", error);
                } finally {
                    updateUI();
                }
            };

            // --- Инициализация игры ---
            const initGame = async () => {
                await loadGame();
                setInterval(saveGame, 5000); // Сохранение каждые 5 секунд
            };

            initGame();
        });
    </script>
</body>
</html>
