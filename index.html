<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Космическая Кузница</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение VK Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/vk-bridge.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Основные стили и запрет взаимодействия с системой --- */
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Запрет прокрутки */
            touch-action: none; /* Запрет жестов, вызывающих прокрутку */
        }

        body {
            font-family: 'Orbitron', sans-serif;
            background: #00000a;
            color: #e0e0ff;
            user-select: none; /* Запрет выделения текста */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(100, 100, 255, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(255, 100, 150, 0.2) 0%, transparent 40%);
        }

        /* --- Анимации --- */
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 40px #4a00e0, 0 0 60px #8e2de2, inset 0 0 20px rgba(255, 255, 255, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 60px #8e2de2, 0 0 90px #4a00e0, inset 0 0 30px rgba(255, 255, 255, 0.5); }
        }

        @keyframes star-dust-animation {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-150px) scale(0.5); opacity: 0; }
        }

        @keyframes number-pop {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .star-dust {
            position: absolute;
            font-size: 2rem;
            color: #fff;
            text-shadow: 0 0 5px #fff, 0 0 10px #ff0;
            animation: star-dust-animation 1s ease-out forwards;
            pointer-events: none;
        }

        .number-pop-animation {
            animation: number-pop 0.3s ease-in-out;
        }

        #proto-star {
            animation: pulse 5s infinite ease-in-out;
        }
        
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: #8e2de2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <!-- Экран загрузки -->
    <div id="loader-overlay" class="absolute inset-0 bg-black/80 flex flex-col justify-center items-center z-50">
        <div class="loader"></div>
        <p id="loader-text" class="mt-4 text-lg text-cyan-300">Ожидание VK Bridge...</p>
    </div>

    <!-- Основной контейнер игры (изначально скрыт) -->
    <div id="game-container" class="w-full h-full max-w-7xl max-h-[1200px] mx-auto flex flex-col p-4 sm:p-8 gap-8 items-center justify-center opacity-0 transition-opacity duration-500">

        <!-- Статистика -->
        <div class="w-full max-w-md text-center bg-black/30 p-4 sm:p-6 rounded-xl border border-purple-700/50 shadow-lg">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-yellow-300 drop-shadow-[0_0_5px_rgba(255,255,0,0.7)]" id="stardust-counter">0</h1>
            <p class="text-base sm:text-lg text-purple-300 mt-2">Звёздной Пыли</p>
        </div>

        <!-- Зона клика (Протозвезда) -->
        <div id="click-area" class="relative w-full flex-grow flex items-center justify-center">
            <div id="proto-star" class="w-[200px] h-[200px] sm:w-[250px] sm:h-[250px] md:w-[300px] md:h-[300px] lg:w-[400px] lg:h-[400px] bg-gradient-to-br from-yellow-200 via-orange-400 to-red-500 rounded-full cursor-pointer transition-transform duration-100 active:scale-95 flex items-center justify-center">
                 <div class="w-full h-full bg-white/30 rounded-full blur-xl"></div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loaderOverlay = document.getElementById('loader-overlay');
            const loaderText = document.getElementById('loader-text');
            
            let attempts = 0;
            const maxAttempts = 50; // 5 секунд (50 * 100ms)

            function runGame() {
                // --- Элементы DOM ---
                const gameContainer = document.getElementById('game-container');
                const stardustCounter = document.getElementById('stardust-counter');
                const protoStar = document.getElementById('proto-star');
                const clickArea = document.getElementById('click-area');

                // --- Игровое состояние ---
                let gameState = {
                    stardust: 0,
                };

                const STARDUST_PER_CLICK = 1;
                const SAVE_KEY = 'cosmicForgeSaveData';

                // --- Форматирование чисел ---
                const formatNumber = (num) => {
                    if (num < 1000) return num.toFixed(0);
                    const suffixes = ["", "K", "M", "B", "T", "Qa", "Qi"];
                    const i = Math.floor(Math.log10(num) / 3);
                    const value = (num / Math.pow(1000, i));
                    return value.toFixed(i > 0 ? 2 : 0) + suffixes[i];
                };

                // --- Обновление UI ---
                const updateUI = () => {
                    stardustCounter.textContent = formatNumber(gameState.stardust);
                    stardustCounter.classList.add('number-pop-animation');
                    stardustCounter.onanimationend = () => stardustCounter.classList.remove('number-pop-animation');
                };

                // --- Клик по звезде ---
                protoStar.addEventListener('mousedown', (e) => {
                    gameState.stardust += STARDUST_PER_CLICK;
                    updateUI();
                    
                    const dust = document.createElement('div');
                    dust.className = 'star-dust';
                    dust.textContent = `+${STARDUST_PER_CLICK}`;
                    const rect = clickArea.getBoundingClientRect();
                    dust.style.left = `${e.clientX - rect.left}px`;
                    dust.style.top = `${e.clientY - rect.top}px`;
                    clickArea.appendChild(dust);
                    setTimeout(() => dust.remove(), 1000);
                });
                
                // --- Сохранение и загрузка ---
                const saveGame = () => {
                    vkBridge.send('VKWebAppStorageSet', { 
                        key: SAVE_KEY, 
                        value: JSON.stringify(gameState) 
                    }).catch(error => console.error("Ошибка сохранения:", error));
                };

                const loadGame = async () => {
                    try {
                        const receivedData = await vkBridge.send('VKWebAppStorageGet', { keys: [SAVE_KEY] });
                        if (receivedData.keys && receivedData.keys[0] && receivedData.keys[0].value) {
                            const savedState = JSON.parse(receivedData.keys[0].value);
                            if (savedState && typeof savedState.stardust === 'number') {
                               gameState = savedState;
                            }
                        }
                    } catch (error) {
                        console.error("Ошибка загрузки:", error);
                    }
                };

                // --- Инициализация игры ---
                const initGame = async () => {
                    try {
                        loaderText.textContent = 'Синхронизация с VK...';
                        await vkBridge.send('VKWebAppInit');
                        await loadGame();
                        setInterval(saveGame, 5000);
                    } catch (error) {
                        console.error("Критическая ошибка инициализации:", error);
                        loaderText.textContent = 'Ошибка подключения к VK';
                        loaderText.classList.add('text-red-500');
                    } finally {
                        updateUI();
                        loaderOverlay.style.display = 'none';
                        gameContainer.style.opacity = '1';
                    }
                };
                initGame();
            }

            // --- Проверка готовности VK Bridge ---
            function waitForVkBridge() {
                if (typeof vkBridge !== 'undefined') {
                    // VK Bridge загружен, запускаем игру
                    runGame();
                } else {
                    attempts++;
                    if (attempts < maxAttempts) {
                        // Проверяем еще раз через 100 мс
                        setTimeout(waitForVkBridge, 100);
                    } else {
                        // Не удалось загрузить за 5 секунд
                        console.error("VK Bridge failed to load in time.");
                        loaderText.textContent = 'Не удалось загрузить библиотеку VK';
                        loaderText.classList.add('text-red-500');
                    }
                }
            }

            waitForVkBridge();
        });
    </script>
</body>
</html>
